---
$title: Last viewed components

serviceWorker:
  location: /last-viewed-components-sw.js
  scope: /styleguide/prototypes/last-viewed-components

serviceWorker@env.gh-pages:
  location: /amp.dev/last-viewed-components-sw.js
  scope: /amp.dev/styleguide/prototypes/last-viewed-components
---
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">

    <script async src="https://cdn.ampproject.org/shadow-v0.js"></script>

    <title>{{ doc.title }}</title>
    <link rel="canonical" href="{{ doc.url|relative }}"/>
    <meta name="viewport" content="width=device-width,minimum-scale=1"/>

    <style>
      html, body {
        margin: 0;
        padding: 0;
      }
    </style>
  </head>

  <body>
    <main>
    </main>

    <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('{{ doc.serviceWorker.location }}', {
          'scope': '{{ doc.serviceWorker.scope }}'
        });

        console.log('Installed Service Worker.');
      });
    }

    function App () {
      // Bootstrap needed variables
      this.currentDocument = null;
      this.$view = document.querySelector('main');

      // Attach handlers
      document.body.addEventListener('click', this.clickHandler.bind(this), false);

      // Load the default document into the view
      this.navigateTo(App.DEFAULT_DOCUMENT);
      console.log('Bootstrapped PWA shell.');
    }

    App.DEFAULT_DOCUMENT = '{{ g.doc('styleguide/prototypes/last-viewed-components/blue-page.html').url|relative }}';

    App.HISTORY_MAX_LENGTH = 4;

    App.prototype.getHistory = function getHistory() {
      // Check if there already is a history if not assume a empty one
      var history = localStorage.getItem('history');
      history = history ? JSON.parse(history) : [];

      // Verify that the history is not longer than the defined maximum
      // and if so shift before pushing a new one
      if (history.length > App.HISTORY_MAX_LENGTH) {
        history.shift();
      }

      return history;
    }

    App.prototype.updateHistory = function updateHistory(doc) {
      document.title = doc.title;
      window.history.pushState({}, doc.title, doc.url);

      var history = this.getHistory();
      history.push({
        'title': doc.title,
        'date': new Date().toLocaleString()
      });

      // Write the updated history back to the local storage
      localStorage.setItem('history', JSON.stringify(history));
      this.propagateHistory();
    };

    App.prototype.propagateHistory = function propagateHistory() {
      // Send the current history over to the Service Worker
      navigator.serviceWorker.ready.then(((serviceWorker) => {
        serviceWorker.active.postMessage({'history': this.getHistory()});
      }).bind(this))
    };

    App.prototype.navigateTo = function navigateTo(url) {
      this.fetchDocument(url).then(((doc) => {
        // Update history before attaching the document. This way there is
        // time to post updates for virtual endpoints to the Service Worker
        this.updateHistory(doc);
        this.attachDocument(doc, url);
      }).bind(this));
    }

    App.prototype.fetchDocument = function fetchDocument(url) {
      var xhr = new XMLHttpRequest();

      return new Promise(function(resolve, reject) {
        xhr.open('GET', url, true);
        xhr.responseType = 'document';
        xhr.setRequestHeader('Accept', 'text/html');
        xhr.onload = function() {
          resolve(xhr.responseXML);
        };
        xhr.send();
      });
    }

    App.prototype.clickHandler = function clickHandler(event) {
      // Check wether the click path contains an <a> and if so prevent
      // navigation and delegate navigation to the PWA shell
      var $anchor = null;
      for (var $element of event.path) {
        if ($element.tagName === 'A') {
          $anchor = $element;
          break;
        }
      }

      if ($anchor) {
        event.preventDefault();

        // Delegate navigation to shell
        this.navigateTo($anchor.href);
      }
    };

    App.prototype.closeCurrentDocument = function closeCurrentDocument() {
      // Check if there is a current document that needs to be closed
      if (this.currentDocument) {
        // Close the currently active document
        this.currentDocument.close();

        // Create a new $view container to render in
        var $view = document.createElement(this.$view.tagName);
        document.body.replaceChild($view, this.$view);
        this.$view = $view;
      }
    }

    App.prototype.attachDocument = function attachDocument(doc, url) {
      return new Promise((resolve, reject) => {
        this.closeCurrentDocument();
        this.currentDocument = AMP.attachShadowDoc(this.$view, doc, url);

        resolve(doc);
      });
    };

    window.AMP = window.AMP || [];
    window.AMP.push(function(AMP) {
      window.app = new App();
    });
    </script>
  </body>
</html>
