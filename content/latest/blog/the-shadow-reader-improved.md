---
class: post-blog post-detail
type: Blog
$title: "The Shadow Reader, Improved"
id: the-shadow-reader-improved
author: Ben Morss
role:  Developer Advocate, Google
origin: "https://amphtml.wordpress.com/2018/06/19/the-shadow-reader-improved/amp/"
excerpt: "We made the Shadow Reader even faster &#8211; and friendlier to search engines! We created the Shadow Reader to demonstrate how AMP pages can be used within a Progressive Web App (PWA) (read our announcement post for more context). The site repurposes existing articles from The Guardian into an immersive news reader experience. More than [&#8230;]"
avatar: https://1.gravatar.com/avatar/42ecb1ea497ca9d0ffe1e406cae70e27?s=96&d=identicon&r=G
date_data: 2018-06-19T20:22:01+02:00
$date: June 19, 2018
$parent: /content/latest/list-blog.html
$path: /latest/blog/{base}/
$localization:
  path: /{locale}/latest/blog/{base}/
components:
  - social-share
inlineCSS: .amp-wp-inline-329fdb7771c10d07df9eb73273c95a60{font-weight:400;}
---

<div class="amp-wp-article-content">

		<p><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">We made <a href="https://amp.cards">the Shadow Reader</a> even faster – and friendlier to search engines!</span></p><p><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">We created </span><a href="https://amp.cards"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">the Shadow Reader</span></a><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60"> to demonstrate how AMP pages can be used within a Progressive Web App (PWA) (read our </span><a href="https://www.ampproject.org/latest/blog/putting-the-amp-in-progressive-web-amps-meet-the-shadowreader/"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">announcement post</span></a><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60"> for more context). The site repurposes existing articles from </span><a href="https://www.theguardian.com"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">The Guardian</span></a><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60"> into an immersive news reader experience. More than just a demo, it’s intended to be a fully functional site. It contains the end-to-end code needed to effectively combine AMP and PWA… it’s ready for production!</span></p><p> </p><h2><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">SEO for JS-generated content</span></h2><p><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">As in any self-respecting single page application, the Shadow Reader’s initial HTML payload is small. It’s a thin app shell that loads quickly, giving the user something to look at while JavaScript loads the main content. This approach makes for a fine user experience!</span></p><p><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">Unfortunately, it can also present a challenge to search engines. Google will try to execute JavaScript in order to index what ultimately appears to the user, not just the initial HTML. But </span><a href="https://moz.com/blog/search-engines-ready-for-javascript-crawling"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">many search engines don’t or do so unreliably</span></a><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">. In other words, it’s not safe to depend on a search engine to successfully execute your JavaScript. And if a search engine sees only the app shell, minus most or all of the content, it won’t be able to properly index the page.</span></p><p><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">Wouldn’t it be nice if the Shadow Reader’s article pages were served to search engines with text included right in the HTML?  And wouldn’t it be amazing if that process didn’t slow down rendering, but instead gave us a way to serve those pages to new users in less than a second?</span></p><p><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">Turns out we can do both of those by serving the AMP version of articles to new users!  After all, a web crawler appears to a server as a new user, too. So… how did we do it?</span></p><p> </p><h2><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">AMP⇒PWA</span></h2><p><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">We did this by implementing an AMP⇒PWA pattern. Here’s how it works!</span></p><p><i><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">For a new user</span></i><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">:</span></p><ul><li class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">When a new user visits an article page, we serve the AMP version of the article.</span></li>
<li class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">The AMP uses </span><a href="https://www.ampproject.org/docs/reference/components/amp-install-serviceworker"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">&lt;amp-install-serviceworker&gt;</span></a><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60"> to load and install the service worker.</span></li>
<li class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">The service worker loads and caches the app shell.</span></li>
<li class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">On the next page navigation, the service worker is in control – and so it gently brings the user into the PWA on that next page.</span></li>
</ul><p><i><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">For an existing user</span></i><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">, we simply serve the PWA.</span></p><p><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">That’s how our site can treat new users and existing users differently at the same URL. For existing users, the service worker is installed. And, when the service worker sees an article URL, it serves its cached version of the PWA.</span></p><p><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">How does this play out in the Shadow Reader?  Let’s say a user first visits this article page:</span></p><pre><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">https://amp.cards/theguardian/us/amazing_article</span></pre><p><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">Seeing an article URL, the server returns the AMP version of the article, but one that installs a service worker when the article is loaded. The service worker, using </span><a href="https://developers.google.com/web/tools/workbox/"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">the Workbox library</span></a><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">, contains this line:</span></p><pre><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">workboxSW.router.registerNavigationRoute('index.html')</span></pre><p><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">This means, whenever the user navigates to a new URL on this domain, the service worker sees that request, and instead of passing it along to the server, it simply serves its cached version of </span><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">index.html</span><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">. That’s our PWA.</span></p><p><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">So if the user next clicks on a link to</span></p><pre><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">https://amp.cards/theguardian/us/another_article</span></pre><p><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">the service worker serves the cached PWA HTML. But the URL is unchanged!  So when the PWA looks at the URL to parse out what article is being requested, it sees the link the user requested, and it can load the proper article into the PWA.</span></p><p><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">Thereafter, any time the user requests a Shadow Reader link, the service worker is already installed, and it serves the cached PWA.</span></p><p><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">Since a web crawler won’t allow us to install a service worker, a web crawler always gets served the AMP article.</span></p><p> </p><p><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">Here’s that flow in a lovely diagram:</span></p><p><amp-img class="alignnone wp-image-2068 amp-wp-enforced-sizes" src="https://amphtml.files.wordpress.com/2018/06/amp-shadow-reader-diagram-v5.png?w=710&amp;h=425" alt="" width="710" height="425" srcset="https://amphtml.files.wordpress.com/2018/06/amp-shadow-reader-diagram-v5.png?w=710&amp;h=425 710w, https://amphtml.files.wordpress.com/2018/06/amp-shadow-reader-diagram-v5.png?w=150&amp;h=90 150w, https://amphtml.files.wordpress.com/2018/06/amp-shadow-reader-diagram-v5.png?w=300&amp;h=180 300w, https://amphtml.files.wordpress.com/2018/06/amp-shadow-reader-diagram-v5.png?w=768&amp;h=460 768w, https://amphtml.files.wordpress.com/2018/06/amp-shadow-reader-diagram-v5.png?w=1024&amp;h=613 1024w, https://amphtml.files.wordpress.com/2018/06/amp-shadow-reader-diagram-v5.png 1419w" sizes="(min-width: 660px) 660px, 100vw"></amp-img></p><p><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">For a </span><b>new user</b><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">:</span></p><ol><li class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">The browser requests an article URL from the server. The server returns an AMP version of the article that includes </span><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">&lt;amp-install-serviceworker&gt;.</span></li>
<li class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">AMP’s serviceworker JS causes the browser to request the service worker. The server sends the service worker JS to the browser. The browser installs the service worker and starts it up.</span></li>
<li class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">The service worker sends the server a request for the PWA app shell. The server sends those resources to the service worker, which caches them.</span></li>
</ol><p><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">For an </span><b>existing user</b><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">:</span></p><ol><li class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">The browser sends a request for an article URL. This request is intercepted by the service worker. The service worker returns the cached PWA to the browser.</span></li>
<li class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">The PWA requests the AMP article. This requests reaches the server, which returns the AMP article to the PWA. The PWA processes and displays that article.</span></li>
</ol><p><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">Remember, a web crawler is always a new user!</span></p><p> </p><h2><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">What’s next?</span></h2><p><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">Now that the Shadow Reader’s got its own server, we’ve got some new TODOs:</span></p><ul><li class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">In the future, we could forgo YQL altogether, simply using the Guardian’s RSS feed directly.</span></li>
<li class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">We also should replace the Guardian’s top nav links with Shadow Reader links.</span></li>
<li class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">We ask the AMP Cache to download and run the entire Shadow Reader in an iframe: </span><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">&lt;amp-install-serviceworker data-iframe-src=”</span><a href="https://amp.cards/index.html"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">https://amp.cards/index.html</span></a><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">“&gt;</span><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">. It might be kinder to the casual user to specify a smaller page instead.</span></li>
<li class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">Backend.js</span><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60"> now gets used in the server as well as the front end, and the way we do that is a bit hacky. Perhaps we should refactor our code to use </span><a href="https://jakearchibald.com/2017/es-modules-in-browsers/"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">ECMAScript modules</span></a><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">?</span></li>
</ul><p><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">Please try this out, </span><a href="https://github.com/ampproject/amp-publisher-sample"><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">check out the code on github</span></a><span class="amp-wp-inline-329fdb7771c10d07df9eb73273c95a60">, and let us know what you think!  We’re curious about how you’re trying out AMP/PWA patterns on your own site, and we’d love to get your ideas for Shadow Reader improvements.</span></p><p> </p><p>Posted by Ben Morss, Developer Advocate, Google</p>	</div>

	

</div>

